<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <title>Tableau de bord</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
<div class="container">
  <h1>Bienvenue sur votre tableau de bord</h1>

  <p>Vous êtes connecté en tant que :
    <span sec:authentication="name"></span>
  </p>

  <h2>Vos programmes</h2>
  <div class="programs-container">
    <!-- Itération sur les programmes -->
    <div th:each="programme : ${programmes}" class="program-card">
      <h2 th:text="${programme.nomProgrammeTherapeutique}">Titre du Programme</h2>
      <h3 th:text="${programme.note}">Titre du Programme</h3>
      <ul>
        <!-- Itération sur les activités du programme -->
        <li th:each="activite : ${programme.activites}" th:text="${activite.nomActivite}">Nom de l'activité</li>
      </ul>
      <div class="program-actions">
        <!-- Bouton Voir le programme -->
        <form th:action="@{/programme/{id}(id=${programme.idProgrammeTherapeutique})}" method="get">
          <button type="submit" class="btn btn-primary">Voir le programme</button>
        </form>
        <!-- Bouton Supprimer avec une pop-up -->
        <button type="button" class="btn btn-danger" th:attr="data-id=${programme.idProgrammeTherapeutique}" onclick="confirmDelete(this)">
          Supprimer
        </button>
      </div>
    </div>

    <div class="program-card add-programme-card">
      <form th:action="@{/ajouter-programme}" method="get">
        <button type="button" class="btn btn-add" onclick="toggleForm()">
          + Ajouter un programme
        </button>
      </form>
    </div>


    <!-- Formulaire caché par défaut -->
    <div id="add-program-form" class="form-popup", style="width: 450px">
      <h2>Ajouter un Programme</h2>
      <form th:action="@{/ajouter-programme}" method="post">
        <!-- Champ pour le nom du programme -->
        <label for="nomProgramme">Nom du Programme :</label>
        <input type="text" id="nomProgramme" name="nomProgramme" required>

        <!-- Sélection des activités -->
        <label>Activités disponibles :</label>
        <div class="activities-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start;">
          <div th:each="activite : ${activites}" style="display: flex; align-items: center; margin-bottom: 8px;">
            <!-- Checkbox alignée à gauche -->
            <input type="checkbox" th:id="${'activite-' + activite.idActivite}"
                   th:name="activitesSelectionnees"
                   th:value="${activite.idActivite}" style="margin-right: 8px; width: 50px">
            <!-- Activité sur la même ligne -->
            <label th:for="${'activite-' + activite.idActivite}" th:text="${activite.nomActivite}"></label>
          </div>
        </div>


        <!-- Boutons du formulaire -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Ajouter</button>
          <button type="button" class="btn btn-secondary" onclick="toggleForm()">Annuler</button>
        </div>
      </form>
    </div>


    <!-- Pop-up de confirmation -->
    <div id="delete-confirmation" class="popup">
      <div class="popup-content">
        <p>Êtes-vous sûr de vouloir supprimer ce programme ?</p>
        <form id="delete-form" th:action="@{/supprimer-programme}" method="post">
          <input type="hidden" id="programme-id" name="idProgrammeTherapeutique">
          <button type="submit" class="btn btn-danger">Oui, supprimer</button>
          <button type="button" class="btn btn-secondary" onclick="closePopup()">Annuler</button>
        </form>
      </div>
    </div>


  </div>

  <h2>Recommendations</h2>
  <div class="recommendations-container">
    <!-- Itération sur les activités recommandées -->
    <div th:each="activite : ${activitesRecommandees}" class="recommendation-card">
      <h2 th:text="${activite.nomActivite}">Nom de l'activité</h2>
      <p th:text="${activite.description}">Description de l'activité</p>
      <form th:action="@{/activite/{id}(id=${activite.idActivite})}" method="get">
        <button type="submit" class="btn btn-secondary">Voir l'activité</button>
      </form>
    </div>
  </div>
  <div class="dashboard-actions">
      <a th:href="@{/activites}" class="btn btn-primary">
          <i class="fas fa-search"></i> Rechercher des activités
      </a>
  </div>

  <br />

  <div class="actions">
    <form th:action="@{/logout}" method="post">
      <button type="submit" class="btn btn-danger">Déconnexion</button>
    </form>
  </div>
</div>

<script>
  function toggleForm() {
    var form = document.getElementById("add-program-form");
    form.style.display = (form.style.display === "block") ? "none" : "block";
  }

  function confirmDelete(button) {
    var programmeId = button.getAttribute("data-id");
    document.getElementById("programme-id").value = programmeId;
    document.getElementById("delete-confirmation").style.display = "flex";
  }

  function closePopup() {
    document.getElementById("delete-confirmation").style.display = "none";
  }
</script>

</body>
</html>