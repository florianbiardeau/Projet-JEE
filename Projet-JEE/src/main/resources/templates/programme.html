<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Détails du Programme</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <meta th:name="_csrf" th:content="${_csrf.token}"/>
    <meta th:name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div class="container">
    <h1 id="programmeNom" contenteditable="true"
        onblur="modifierNomProgramme(this, this.getAttribute('data-id'))"
        th:attr="data-id=${programme.idProgrammeTherapeutique}, onkeydown='handleEnter(event, this, this.getAttribute(\'data-id\'))'"
        th:text="${programme.nomProgrammeTherapeutique}">
    </h1>

    <p>Note : <strong><span th:text="${moyenneNote}">Note</span></strong></p>

    <button class="btn btn-success" onclick="ouvrirPopup()">Ajouter une ou des activité(s)</button>

    <h2>Activités associées</h2>
    <ul>
        <li th:each="activite : ${programme.activites}">
            <strong th:text="${activite.nomActivite}">Nom de l'activité</strong>

            <p><strong>Discipline :</strong> <span th:text="${activite.discipline}">Discipline</span></p>
            <p><strong>Description :</strong> <span th:text="${activite.description}">Description de l'activité</span></p>
            <p><strong>Durée :</strong> <span th:text="${activite.duree}">Durée</span> minutes</p>
            <p><strong>Votre note :</strong>
                <span th:if="${note != null && note.get(activite.idActivite) > 0}" th:text="${#numbers.formatDecimal(note.get(activite.idActivite), 1, 1)}"></span>
                <span th:if="${note == null || note.get(activite.idActivite) == 0}">Vous n'avez pas encore noté cette activité</span>
            </p>
            <div class="note-moyenne">
                <strong>Note moyenne :</strong>
                <span th:if="${notesMoyennes != null && notesMoyennes.get(activite.idActivite) > 0}"
                      th:text="${#numbers.formatDecimal(notesMoyennes.get(activite.idActivite), 1, 1)}">
                </span>
                <span th:if="${notesMoyennes == null || notesMoyennes.get(activite.idActivite) == 0}">Non notée</span>
                <small th:if="${nombreAvis != null && nombreAvis.get(activite.idActivite) > 0}">
                    (<span th:text="${nombreAvis.get(activite.idActivite)}"></span> avis)
                </small>
            </div>
            <p><strong>Adresse :</strong></p>
            <p>
                <span th:text="${activite.numeroDeRue}">Numéro</span>,
                <span th:text="${activite.rue}">Rue</span>,<br>
                <span th:text="${activite.ville}">Ville</span>,
                <span th:text="${activite.pays}">Pays</span>
            </p>

            <!-- Bouton pour supprimer une activité -->
            <button class="btn btn-danger"
                    th:attr="onclick='ouvrirPopupSuppression(' + ${activite.idActivite} + ',' + ${programme.idProgrammeTherapeutique} + ')'" >
                Supprimer cette activité du programme
            </button>


        </li>
    </ul>

    <a href="/dashboard" class="btn btn-secondary">Retour au Tableau de Bord</a>
</div>

<div id="popup" class="popup-container">
    <div class="popup-content">
        <span class="close" onclick="fermerPopup()">&times;</span>
        <h2>Ajouter des activités</h2>

        <!-- Liste des activités à sélectionner -->
        <form id="ajoutActivitesForm" th:action="@{/programme/{id}/ajouter-activites(id=${programme.idProgrammeTherapeutique})}" method="post">
            <div th:each="activite : ${activitesDisponibles}">
                <input type="checkbox" name="activitesSelectionnees" th:value="${activite.idActivite}">
                <label th:text="${activite.nomActivite}">Nom de l'activité</label>
            </div>
            <button type="submit" class="btn btn-primary">Ajouter</button>
        </form>
    </div>
</div>

<!-- Popup de confirmation de suppression -->
<div id="popupSuppression" class="popup-container" style="display: none;">
    <div class="popup-content">
        <span class="close" onclick="fermerPopupSuppression()">&times;</span>
        <h2>Confirmer la suppression</h2>
        <p>Êtes-vous sûr de vouloir supprimer cette activité du programme ?</p>
        <form id="suppressionForm" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="btn btn-danger">Supprimer</button>
            <button type="button" class="btn btn-secondary" onclick="fermerPopupSuppression()">Annuler</button>
        </form>
    </div>
</div>

<script>
    function ouvrirPopup() {
        document.getElementById("popup").style.display = "flex";
    }

    function fermerPopup() {
        document.getElementById("popup").style.display = "none";
    }

    function ouvrirPopupSuppression(idActivite, idProgramme) {
        console.log("Ouverture du popup de suppression");

        let form = document.getElementById("suppressionForm");
        form.setAttribute("action", "/programme/" + idProgramme + "/supprimer-activite?idActivite=" + idActivite);

        document.getElementById("popupSuppression").style.display = "flex";

        console.log("Popup affiché avec succès");
    }


    function fermerPopupSuppression() {
        document.getElementById("popupSuppression").style.display = "none";
    }


    function modifierNomProgramme(element, programmeId) {
        let nouveauNom = element.innerText.trim();

        if (nouveauNom === "") {
            alert("Le nom du programme ne peut pas être vide.");
            return;
        }

        // Récupération du token CSRF depuis les meta tags
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        // Envoi AJAX pour sauvegarder la modification
        fetch("/programme/" + programmeId + "/modifier-nom", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfToken // Ajout dynamique du header CSRF
            },
            body: JSON.stringify({nomProgramme: nouveauNom})
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Erreur lors de la mise à jour.");
                }
                return response.text();
            })
            .then(data => {
                console.log("Nom du programme mis à jour :", data);
            })
            .catch(error => {
                console.error("Erreur :", error);
                alert("Une erreur est survenue lors de la mise à jour.");
            });
    }

    function handleEnter(event, element, programmeId) {
        if (event.key === "Enter") {
            event.preventDefault();  // Empêche le retour à la ligne
            element.blur();  // Déclenche l'événement `onblur` pour sauvegarder
        }
    }

    document.getElementById('ratingForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Récupération du token CSRF
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        if (!csrfToken || !csrfHeader) {
            alert('Erreur de sécurité - Rechargez la page');
            return;
        }

        const activiteId = document.getElementById('activiteId').value;
        const note = document.getElementById('note').value;

        fetch(`/api/activites/${activiteId}/rate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken // Utilisation dynamique du nom du header
            },
            credentials: 'include', // Important pour les cookies
            body: JSON.stringify({ note: parseInt(note) })
        })
            .then(response => {
                if (response.ok) {
                    $('#ratingModal').modal('hide');
                    alert('Note enregistrée !');
                } else if (response.status === 403) {
                    alert('Session expirée - Reconnectez-vous');
                    window.location.href = '/login';
                } else {
                    throw new Error(`Erreur HTTP : ${response.status}`);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert(`Échec : ${error.message}`);
            });
    });

    function openRatingModal(activiteId) {
        document.getElementById('activiteId').value = activiteId;
        $('#ratingModal').modal('show');
    }

    function openAddProgrammeModal(activityId) {
        document.getElementById('activityId').value = activityId;
        // Réinitialiser le select si besoin
        document.getElementById('programmeSelect').selectedIndex = 0;
        $('#addProgrammeModal').modal('show');
    }


</script>

</body>
</html>
